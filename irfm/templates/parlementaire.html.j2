{% extends "_base.html.j2" %}

{% block menuitem %}
  <li role="presentation" class="active"><a href="#">{{ parlementaire.nom_complet }}</a></li>
{% endblock %}

{% block content %}
  <div class="col-md-4">
    <section class="panel panel-default">
      <article class="panel-body parl-card">
        <img class="parl-photo" src="{{ parlementaire.url_photo }}/120" align="left">
        <div class="parl-detail">
          <b>{{ parlementaire.nom_complet }}</b>
            {{ parlementaire.groupe|label_groupe }}
            <a title="Accéder à la page du parlementaire" target="_blank" href="{{ parlementaire.url_off }}">
              <img class="chamber-icon" src="{{ url_for('static', filename=parlementaire.chambre|lower+'.png') }}">
            </a>
          <br>

          {{ parlementaire|fonc_parlementaire }}
            &ndash; {{ parlementaire.nom_circo }} n°{{ parlementaire.num_circo }}
          <br><br>

          {{ parlementaire.etape|label_etape }}
          {% if not parlementaire.adresse %}
            <span class="label label-danger">Adresse manquante !</span>
          {% endif %}
        </div>
      </article>
    </section>

    {% if parlementaire.etape.ordre == ordres.ETAPE_A_ENVOYER %}
      {% if session.user %}
        <section class="panel panel-default">
          <article class="panel-body">
            <a class="btn btn-primary btn-lg btn-block" href="{{ url_for('envoi', id=parlementaire.id) }}">Je prends en charge l'envoi !</button>
            <a class="btn btn-default btn-lg btn-block" href="{{ url_for('demande_pdf', id=parlementaire.id, mode='download') }}">Télécharger le courrier au format PDF</a>
          </article>
        </section>
      {% endif %}
    {% elif pris_en_charge %}
      <section class="panel panel-default">
        <header class="panel-heading">
          <b>Confirmation d'envoi</b>
        </header>
        <article class="panel-body">
          Vous avez pris en charge l'envoi du courrier à ce parlementaire. Pour confirmer l'envoi,
          merci de nous envoyer une photo ou un scan de la preuve de dépôt (format PDF, PNG ou JPG, 4 Mo maximum) à l'aide du formulaire ci-dessous.

          <form method="POST" action="{{ url_for('confirmer', id=parlementaire.id) }}" enctype="multipart/form-data">
            <div class="form-group">
              <label class="col-md-4" for="file">Preuve d'envoi</label>
              <div class="col-md-8">
                <input name="file" type="file" title="Choisissez un fichier...">
              </div>
            </div>
            <div class="form-group">
              <div class="col-md-offset-4 col-md-8">
                <br>
                <input class="btn btn-primary" type="submit" value="Confirmer !">
                <a href="{{ url_for('annuler', id=parlementaire.id) }}" class="btn btn-danger">Annuler la prise en charge</a>
              </div>
            </div>
          </form>
        </article>
      </section>
    {% endif %}
  </div>

  {% if parlementaire.etape.ordre == ordres.ETAPE_A_ENVOYER %}
    {% if session.user %}
      <div class="col-md-8">
        <section class="panel panel-default">
          <header class="panel-heading">
            <b>Quelle est la marche à suivre ?</b>
          </header>
          <article class="panel-body">
            {% filter markdown -%}
              {% include "text/howto_envoi.md" %}
            {% endfilter %}
          </article>
        </section>
      </div>

      <div class="col-md-12" id="letter-container">
        <iframe name="demande" id="demande" src="{{ url_for('demande_pdf', id=parlementaire.id, mode='show') }}">
        </iframe>
      </div>
    {% else %}
      <div class="col-md-8">
        <div class="alert alert-warning" role="alert">
          Pour envoyer une demande et assurer son suivi, il faut au préalable <a href="#" id="identify-link">vous identifier</a>.
        </div>
      </div>
    {% endif %}
  {% else %}
    <div class="col-md-8">
      <section class="panel panel-default">
        <header class="panel-heading">
          <b>Avancement</b>
        </header>

        <table class="table table-striped">
          <tr>
            <th>Etape</th>
            <th>Utilisateur</th>
            <th>Date</th>
            <th></th>
          </tr>

          {% for act in parlementaire.actions %}
            <tr>
              <td>{{ act.etape|label_etape }}</td>
              <td>{{ act.nick }}</td>
              <td>{{ act.date.strftime("%c") }}</td>
              <td class="col-right">
                {% if act.etape.ordre == ordres.ETAPE_A_CONFIRMER %}
                  <a class="btn btn-default btn-sm" target="_blank" href="{{ url_for('demande_pdf', id=parlementaire.id, mode='show') }}">Voir le courrier</a>
                {% elif act.etape.ordre == ordres.ETAPE_ENVOYE and act.attachment %}
                  <a class="btn btn-default btn-sm" target="_blank" href="{{ url_for('preuve_envoi', id=parlementaire.id) }}">Voir la preuve d'envoi</a>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </table>
      </section>
    </div>
  {% endif %}
{% endblock %}

{% block scripts %}
  <script src="{{ url_for('static', filename='bootstrap.file-input.js') }}"></script>
  <script>
    $('#identify-link').click(function() {
      $('.login .dropdown-toggle').dropdown('toggle');
    });

    $('input[type=file]').bootstrapFileInput();
  </script>
{% endblock %}
