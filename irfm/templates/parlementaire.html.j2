{% extends "_base.html.j2" %}

{% block menuitem %}
  <li role="presentation" class="active"><a href="#">{{ parlementaire.nom_complet }}</a></li>
{% endblock %}

{% block content %}
  <div class="col-md-4">
    <section class="panel panel-default">
      <article class="panel-body parl-card">
        <img class="parl-photo" src="{{ parlementaire.url_photo }}/120" align="left">
        <div class="parl-detail">
          <b>{{ parlementaire.nom_complet }}</b>
            {{ parlementaire.groupe|label_groupe }}
            <a title="Accéder à la page du parlementaire ({{ chambres[parlementaire.chambre] }})" data-toggle="tooltip" target="_blank" href="{{ parlementaire.url_off }}">
              <img class="chamber-icon" src="{{ url_for('static', filename=parlementaire.chambre|lower+'.png') }}">
            </a>
          <br>

          {{ parlementaire|fonc_parlementaire }}
            &ndash; {{ parlementaire.nom_circo }} n°{{ parlementaire.num_circo }}
          <br><br>

          {{ parlementaire.etape|label_etape }}
          {% if not parlementaire.adresse %}
            <span class="label label-danger">Adresse manquante !</span>
          {% endif %}
        </div>
      </article>
    </section>

    {% if parlementaire.etape.ordre == ordres.ETAPE_A_ENVOYER %}
      {% if session.user %}
            <a class="btn btn-primary btn-lg btn-block" href="{{ url_for('envoi', id=parlementaire.id) }}">
              <i class="fa fa-thumbs-up"></i>
              Je prends en charge l'envoi !
            </a>
      {% endif %}
    {% elif parlementaire.etape.ordre == ordres.ETAPE_A_CONFIRMER and (pris_en_charge or (session.user and session.user.admin)) %}
      <section class="panel panel-default">
        <header class="panel-heading">
          <b>Confirmation d'envoi</b>
        </header>
        <article class="panel-body">
          {% if pris_en_charge %}
            Vous avez pris en charge l'envoi du courrier à ce parlementaire. Merci !<br><br>

            <b>Revenez sur cette page une fois l'envoi effectué.</b><br><br>

            Pour confirmer l'envoi, saisissez ci-dessous le numéro de suivi du recommandé.  Vous pouvez aussi joindre une photo ou un scan de la preuve de dépôt (format PDF, PNG ou JPG, 4 Mo maximum) si vous le souhaitez.
          {% elif session.user.admin %}
            <span class="admin">
              Vous êtes administrateur&nbsp;: vous pouvez confirmer ou annuler à la place de l'utilisateur.
            </span>
          {% endif %}

          <form method="POST" action="{{ url_for('confirmer', id=parlementaire.id) }}" enctype="multipart/form-data">
            <div class="form-group">
              <div class="col-md-4">
                <label for="suivi">Numéro de suivi</label>
              </div>
              <div class="col-md-8">
                <input name="suivi" type="text" placeholder="Ex: 1X12345678901" maxlength="13"> <b>*</b>
              </div>
            </div>
            <div class="form-group">
              <div class="col-md-4">
                <label for="file">Preuve d'envoi</label>
              </div>
              <div class="col-md-8">
                <input name="file" type="file" title="Choisissez un fichier...">
              </div>
            </div>
            <div class="form-group">
              <div class="col-md-offset-4 col-md-8">
                <br>
                <input class="btn btn-primary" type="submit" value="Confirmer !">
                <a href="{{ url_for('annuler', id=parlementaire.id) }}" class="btn btn-danger">Annuler la prise en charge</a>
              </div>
            </div>
          </form>
        </article>
      </section>
    {% endif %}
  </div>

  {% if parlementaire.etape.ordre == ordres.ETAPE_A_ENVOYER %}
    {% if not session.user %}
      <div class="col-md-8">
        <div class="alert alert-warning" role="alert">
          Pour envoyer une demande et assurer son suivi, il faut au préalable <a href="#" id="identify-link">vous identifier</a>.
        </div>
      </div>
    {% endif %}
  {% endif %}

  {% if parlementaire.etape.ordre > ordres.ETAPE_A_ENVOYER %}
    <div class="col-md-8">
      <section class="panel panel-default">
        <header class="panel-heading">
          <b>Avancement</b>
        </header>

        <table class="table table-striped">
          <tr>
            <th>Etape</th>
            <th>Utilisateur</th>
            <th>Date</th>
            <th></th>
            <th></th>
          </tr>

          {% for act in parlementaire.actions %}
            <tr>
              <td>{{ act.etape|label_etape }}</td>
              <td>
                {% if act.nick == '!rc' %}
                  <img class="rc-small" src="{{ url_for('static', filename='rc.png') }}">
                {% else %}
                  {{ act.nick }}
                {% endif %}
              </td>
              <td>{{ act.date.strftime("%c") }}</td>
              <td>
                {% if act.suivi %}
                  Suivi&nbsp;: <a href="http://www.part.csuivi.courrier.laposte.fr/suivi/index?id={{ act.suivi }}" target="_blank">{{ act.suivi }}</a>
                {% endif %}
              </td>
              <td class="col-right">
                {% if act.etape.ordre == ordres.ETAPE_A_CONFIRMER %}
                  <a class="btn btn-default btn-sm" target="_blank" href="{{ url_for('demande_pdf', id=parlementaire.id, mode='show') }}">Voir le courrier</a>
                {% elif act.etape.ordre == ordres.ETAPE_ENVOYE and act.attachment %}
                  <a class="btn btn-default btn-sm" target="_blank" href="{{ url_for('preuve_envoi', id=parlementaire.id) }}">Voir la preuve d'envoi</a>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </table>
      </section>
    </div>
  {% endif %}

  {% if (parlementaire.etape.ordre == ordres.ETAPE_A_ENVOYER and session.user) or pris_en_charge %}
    <div class="col-md-8">
      <section class="panel panel-default">
        <header class="panel-heading">
          <b>Quelle est la marche à suivre ?</b>
        </header>
        <article class="panel-body">
          {% filter markdown -%}
            {% include "text/howto_envoi.md" %}
          {% endfilter %}
        </article>
      </section>
    </div>

    <div class="col-md-12" id="letter-container">
      <a class="btn btn-default btn-lg" href="{{ url_for('demande_pdf', id=parlementaire.id, mode='download') }}">
        <i class="fa fa-download"></i>
        Télécharger le courrier au format PDF
      </a>
      <br><br>
      <iframe name="demande" id="demande" src="{{ url_for('demande_pdf', id=parlementaire.id, mode='show') }}">
      </iframe>
    </div>
  {% endif %}
{% endblock %}

{% block scripts %}
  <script src="{{ url_for('static', filename='bootstrap.file-input.js') }}"></script>
  <script>
    $('#identify-link').click(function() {
      $('.login .dropdown-toggle').dropdown('toggle');
    });

    $('input[type=file]').bootstrapFileInput();
  </script>
{% endblock %}
